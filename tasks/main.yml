---
- name: Use the distro version of Ansible to install another version using pip
  block:

    - name: Check the distro version of Ansible
      command: "{{ ans_distro_path }} --version"
      check_mode: false
      changed_when: false
      register: ans_distro_version_installed

    - name: Set a fact for the ans_distro_version
      set_fact:
        ans_distro_version: "{{ ans_distro_version_installed.stdout_lines[0] | regex_replace('^ansible ') | trim }}"

    - name: "Ansible {{ ans_distro_path }} version"
      debug:
        var: ans_distro_version

    - name: Get a list of available pypi Ansible versions
      uri:
        url: https://pypi.org/pypi/ansible/json
        method: GET
        return_content: true
      check_mode: false
      changed_when: false
      register: ans_pypi

    - name: Create an array of the Ansible versions available
      set_fact:
        ans_versions_available: "{{ ans_versions_available | default([]) }} + [ '{{ ver.key | string }}' ]"
      loop: "{{ ans_pypi.json.releases | dict2items }}"
      loop_control:
        loop_var: ver
        label: "{{ ver.key }}"

    - name: Debug available versions
      debug:
        var: ans_versions_available
        verbosity: 3

    - name: Loop through the Ansible versions available to check the veriable type
      debug:
        msg: "Ansible version {{ version }} is {{ version | type_debug }}"
        verbosity: 2
      loop: "{{ ans_versions_available }}"
      loop_control:
        loop_var: version
        label: "{{ version }}"

    - name: Debug Ansible version type
      debug:
        msg:
          - "Ansible version {{ ans_version }} is {{ ans_version | type_debug }}"
        verbosity: 3

    - name: Loop through the Ansible versions available to check that that the proposed Ansible version is available via pypi
      debug:
        msg: "Ansible version {{ ans_version }} is available via pypi"
        verbosity: 3
      when: ( ver | string ) is version(ans_version, '==')
      loop: "{{ ans_versions_available }}"
      loop_control:
        loop_var: ver
        label: "{{ ver }}"

    - name: Ensure that the proposed Ansible version is available via pypi
      assert:
        that:
          - ans_version in ans_versions_available

  tags:
    - ansible
...
